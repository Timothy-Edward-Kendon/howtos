# WSL2 - Equinor PC (Working from home with VPN)

## <br>

## Setting the company proxy

<br>

1. Open `sudo vim /etc/environment` file and add

   ```sh
   http_proxy=http://www-proxy.statoil.no:80
   https_proxy=http://www-proxy.statoil.no:80
   ```

2. Open `sudo vim /etc/bash.bashrc` file and add:

   ```sh
   export http_proxy=http://www-proxy.statoil.no:80
   export https_proxy=http://www-proxy.statoil.no:80
   ```

3. Open `sudo vim /etc/apt/apt.conf.d/proxy.conf` file and add:

   ```sh
   Acquire::http::Proxy "http://www-proxy.statoil.no:80";
   Acquire::https::Proxy "http://www-proxy.statoil.no:80";
   ```

4. Open `sudo vim /etc/wgetrc` file and add:

   ```sh
   use_proxy = on
   http_proxy = http://www-proxy.statoil.no:80/
   https_proxy = http://www-proxy.statoil.no:80/
   ftp_proxy = http://www-proxy.statoil.no:80/
   ```

## <br>

## Setting the nameserver

<br>

1. Connect to Cisco AnyConnect VPN
2. In the Powershell Terminal, type

   ```powershell
   Get-DnsClientServerAddress | Select-Object -ExpandProperty ServerAddresses
   ```

   The first two lines returned should be the Corporate DNS nameservers

   ```c
   143.97.22.44
   143.97.1.115
   ...
   ```

3. In WSL Ubuntu terminal, type

   ```bash
   sudo rm /etc/resolv.conf
   sudo bash -c 'echo "nameserver 172.17.128.33" > /etc/resolv.conf'
   sudo bash -c 'echo "nameserver 143.97.22.44" >> /etc/resolv.conf'
   sudo bash -c 'echo "nameserver 143.97.1.115" >> /etc/resolv.conf'
   sudo bash -c 'echo "[network]" > /etc/wsl.conf'
   sudo bash -c 'echo "generateResolvConf = false" >> /etc/wsl.conf'
   wsl.exe --shutdown
   ```

   The WSL creates a /etc/resolv.conf file with the following entry

   ```sh
   # This file was automatically generated by WSL. To stop automatic generation of this file, add the following entry to /etc/wsl.conf:
   # [network]
   # generateResolvConf = false
   nameserver 172.17.128.33
   ```

   The command `wsl.exe --shutdown` is necessary to ensure `/etc/wsl.conf` is read to prevent autogeneration. The `172.17.128.33` should be the `Ethernet adapter vEthernet (WSL)` returned from running `ipconfig` in a Window's command prompt or powershell.

4. Before restarting the wsl environment, open a Powershell console as administrator, and type:

   ```powershell
   Get-NetAdapter | Where-Object {$_.InterfaceDescription -Match "Cisco AnyConnect"} | Set-NetIPInterface -InterfaceMetric 4000

   Get-NetIPInterface -InterfaceAlias "vEthernet (WSL)" | Set-NetIPInterface -InterfaceMetric 1
   ```

   This step needs to be done everytime at startup before restarting wsl. These two lines change the Interface Metric so that the WSL interface has a higher priority than the VPN connection.

**Important!** To run visual studio code from within the Ubuntu WSL interfaces, you need to (re)start wsl.exe after the changes made in step 4 above. If your wsl.exe is already running, then:

- Close you Ubuntu terminals in Windows Terminal
- Type `wsl --shutdown` in say PowerShell or CMD (with Admin privileges)
- Re-open an Ubuntu tab in Windows Terminal and you should be good to go.

## <br>

## Adding company CA-certificates

<br>

1. Download company certificates from [GitLab](https://git.equinor.com/sdstrh/linux/-/blob/master/statoil-certs/ca-bundle.crt)
2. Create a directory (ie extra) in the ca-certs to hold the new certs

   `sudo mkdir /usr/share/ca-certificates/extra`

3. Copy or move the certs into the new directory

   `sudo cp *.crt /usr/share/ca-certificates/extra`

4. Tell Ubuntu to add this directory to the certs list

   `sudo dpkg-reconfigure ca-certificates`

## <br>

## Setting up a Desktop environment

<br>

1. Update and install a minimalistic Desktop environment and remote desktop
   ```sh
   sudo apt update && sudo apt -y upgrade
   sudo apt-get install -y xfce4 xfce4-goodies
   sudo apt-get install xrdp -y
   ```
2. Then `sudo vim /etc/xrdp/startwm.sh` and edit the bottom of file to look like this

   ```sh
   # test -x /etc/X11/Xsession && exec /etc/X11/Xsession
   # exec /bin/sh /etc/X11/Xsession

   # xfce4
   startxfce4
   ```

   Please note the space after the `#`; it is required for it to work.

3. Then type
   ```sh
   sudo cp /etc/xrdp/xrdp.ini /etc/xrdp/xrdp.ini.bak
   sudo sed -i 's/3389/3390/g' /etc/xrdp/xrdp.ini
   sudo sed -i 's/max_bpp=32/#max_bpp=32\nmax_bpp=128/g' /etc/xrdp/xrdp.ini
   sudo sed -i 's/xserverbpp=24/#xserverbpp=24\nxserverbpp=128/g' /etc/xrdp/xrdp.ini
   echo xfce4-session > ~/.xsession
   # enable dbus
   sudo systemctl enable dbus
   sudo /etc/init.d/dbus start
   sudo /etc/init.d/xrdp start
   #check xrdp status
   sudo /etc/init.d/xrdp status
   ```
4. Check the ip address with `ifconfig` or `ip addr`
5. Logon via Windows Remote Desktop using `localhost:3390`

## Setting up a Desktop environment (extended X2Go)

1. Fix SSH host keys

   ```sh
   sudo apt-get remove --purge openssh-server
   sudo apt-get install openssh-server
   sudo service ssh --full-restart
   ```

2. Install X2Go on the Linux distribution

   ```sh
   apt install x2goserver
   ```

3. Download and install the client for Windows (accessIT)

4. Configure the
   *Host: "localhost"
   *Login: "your user"
   \*Session-type: "xfce"

5. After each WSL/Windows restart

   ```sh
   sudo service ssh start
   ```

## <br>

## References

<br>

1. https://github.com/microsoft/vscode-remote-release/issues/1611
2. https://github.com/microsoft/WSL/issues/5068
